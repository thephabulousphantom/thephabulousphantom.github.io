app.ff.GameScene=function(e,a,i,t,n,o,s,r,f,l,c,d,u,g,m,S,b,y,k,v,x){var P=Class.inherit(this,app.Scene,[e,a]);var w={};w.patterns=x;w.startTime=null;w.fishermanOffset={x:i,y:t};w.fishermanScale=n;w.bucketOffset={x:o,y:s};w.bucketScale=r;w.fishScale=f;w.hookOffset={x:c,y:d};w.hookScale=u;w.ended=false;w.aborted=false;w.fishAnimationFrames=[1,0,2,0];w.bucketPosition=0;w.beatsPerMillisecond=g;w.millisecondsPerBeat=1/w.beatsPerMillisecond;w.fishTravelTime=2*w.millisecondsPerBeat;w.latencyTotal=0;w.latencyMean=0;w.latencyDeviation=0;w.hearts=0;w.playbackStarted=false;w.lastBeats=0;w.handIsFishing=false;w.tolerance=null;w.lastProgress=-1;w.standardDeviationGreen=app.ff.State.deviationGreen();w.standardDeviationYellow=app.ff.State.deviationYellow();w.standardDeviationRed=app.ff.State.deviationRed();w.hand=new app.gfx.Sprite("hand","img/ffHand.png",1,2210+w.fishermanOffset.x,5550+w.fishermanOffset.y,w.fishermanScale*2030,w.fishermanScale*4760);w.head=new app.gfx.Sprite("head","img/ffHead"+app.ff.State.difficulty()+".png",2,3650+w.fishermanOffset.x,4830+w.fishermanOffset.y,w.fishermanScale*2950,w.fishermanScale*3730);w.hook=new app.gfx.Sprite("hook","img/"+l+".png",1,770+w.hookOffset.x+w.fishermanOffset.x,12160+w.hookOffset.y,.5*1150,.5*2770);w.bucket=new app.gfx.Sprite("bucket","img/bucket.png",2,8130+w.bucketOffset.x-2080*w.bucketScale/2,10300+w.bucketOffset.y-1970*w.bucketScale/2,2080*w.bucketScale,1970*w.bucketScale);w.progress=[new app.gfx.Sprite("progress0","img/progress.png",1,6070+0*430,360,520,690),new app.gfx.Sprite("progress1","img/progress.png",1,6070+1*430,360,520,690),new app.gfx.Sprite("progress2","img/progress.png",1,6070+2*430,360,520,690),new app.gfx.Sprite("progress3","img/progress.png",1,6070+3*430,360,520,690),new app.gfx.Sprite("progress4","img/progress.png",1,6070+4*430,360,520,690),new app.gfx.Sprite("progress5","img/progress.png",1,6070+5*430,360,520,690),new app.gfx.Sprite("progress6","img/progress.png",1,6070+6*430,360,520,690),new app.gfx.Sprite("progress7","img/progress.png",1,6070+7*430,360,520,690),new app.gfx.Sprite("progress8","img/progress.png",1,6070+8*430,360,520,690),new app.gfx.Sprite("progress9","img/progress.png",1,6070+9*430,360,520,690)];w.heart=[new app.gfx.Sprite("heart0","img/heart.png",2,1620+0*800,1520,860,760),new app.gfx.Sprite("heart1","img/heart.png",2,1620+1*800,1520,860,760),new app.gfx.Sprite("heart2","img/heart.png",2,1620+2*800,1520,860,760),new app.gfx.Sprite("heart3","img/heart.png",2,1620+3*800,1520,860,760),new app.gfx.Sprite("heart4","img/heart.png",2,1620+4*800,1520,860,760)];w.fish1Pool=new app.gfx.SpritePool(4,"fish1","img/trash1.png",4,12e3,16e3,w.fishScale*5840/4,w.fishScale*2690);w.fish2Pool=new app.gfx.SpritePool(4,"fish2","img/trash2.png",4,12e3,16e3,w.fishScale*4800/4,w.fishScale*2570);w.fish3Pool=new app.gfx.SpritePool(4,"fish3","img/trash3.png",4,12e3,16e3,w.fishScale*8200/4,w.fishScale*1330);w.siren=null;w.fish4Pool=null;w.fish5Pool=null;w.fish6Pool=null;w.precisionBall=new app.gfx.Sprite("precisionBall","img/precisionBall.png",1,-450,440,450,470);w.abortButton=new app.gfx.Sprite("abortButton","img/abortButton.png",1,9470,1290,1070,1070);w.startButton=new app.gfx.Sprite("startButton","img/startButton.png",1,2550,6500,6400,2240);w.restartButton=new app.gfx.Sprite("restartButton","img/restartButton.png",1,2960,6330,2740,3240);w.stopButton=new app.gfx.Sprite("stopButton","img/stopButton.png",1,5730,6330,2810,3240);w.brokenHeart=new app.gfx.Sprite("brokenHeart","img/brokenHeart.png",1,3110,3800,5430,2470);w.baloon=new app.gfx.Text("baloon","img/dialogLeft.png","X",512,85,"ComicBookFont","#444",2480,13580-4e3-3190,3820,3190,550,true,true,550,350,350,950);w.music=new app.sfx.Sound("music","sfx/"+m,S,true);w.musicChannel=new app.sfx.Channel("music");w.original={head:new app.gfx.Position(w.head.position.x,w.head.position.y),hand:new app.gfx.Position(w.hand.position.x,w.hand.position.y),hook:new app.gfx.Position(w.hook.position.x,w.hook.position.y),bucket:new app.gfx.Position(w.bucket.position.x,w.bucket.position.y)};P.init=function(e,a){var i=30;if(w.fishUsed("S")){w.siren=new app.gfx.Sprite("siren","img/siren.png",4,0,0,w.fishScale*3180,w.fishScale*4670);i++}if(w.fishUsed("4")){w.fish4Pool=new app.gfx.SpritePool(2,"fish4","img/fish1.png",4,12e3,16e3,w.fishScale*8840/4,w.fishScale*1760);i++}if(w.fishUsed("5")){w.fish5Pool=new app.gfx.SpritePool(2,"fish5","img/fish2.png",4,12e3,16e3,w.fishScale*11680/4,w.fishScale*2330);i++}if(w.fishUsed("6")){w.fish6Pool=new app.gfx.SpritePool(2,"fish6","img/fish3.png",4,12e3,16e3,w.fishScale*12840/4,w.fishScale*1710);i++}P.loading(i,a);w.tolerance=5*w.millisecondsPerBeat/16;P.base.init(e,w.onInit)};w.onInit=function(){w.head.position.x=w.original.hand.x+w.fishermanScale*(w.head.position.x-w.original.hand.x);w.head.position.y=w.original.hand.y+w.fishermanScale*(w.head.position.y-w.original.hand.y);w.original.head.x=w.head.position.x;w.original.head.y=w.head.position.y;for(p=0;p<w.progress.length;p++){P.addSprite(w.progress[p],P.loaded)}for(h=0;h<w.heart.length;h++){P.addSprite(w.heart[h],P.loaded)}P.addSprite(w.bucket,P.loaded);P.addSprite(w.hand,P.loaded);P.addSprite(w.hook,P.loaded);P.addSprite(w.head,P.loaded);P.addSprite(w.baloon,P.loaded);w.fish1Pool.init(P,P.loaded);w.fish2Pool.init(P,P.loaded);w.fish3Pool.init(P,P.loaded);if(w.siren){P.addSprite(w.siren,P.loaded)}if(w.fish4Pool){w.fish4Pool.init(P,P.loaded)}if(w.fish5Pool){w.fish5Pool.init(P,P.loaded)}if(w.fish6Pool){w.fish6Pool.init(P,P.loaded)}P.addSprite(w.precisionBall,P.loaded);P.addSprite(w.abortButton,P.loaded);P.addSprite(w.startButton,P.loaded);P.addSprite(w.restartButton,P.loaded);P.addSprite(w.stopButton,P.loaded);P.addSprite(w.brokenHeart,P.loaded);w.abortButton.onclick=function(){P.bounce("abortButton",-300,200,P.abort)};w.hook.frameskip(0,0);w.hand.frameskip(3,0);w.head.frameskip(3,1);w.bucket.frameskip(3,2);w.bucket.onclick=w.onBucketClicked;w.startButton.onclick=P.startPlayback;w.restartButton.onclick=P.restartPlayback;w.stopButton.onclick=P.stopPlayback;w.baloon.onclick=w.onbaloon;w.bucket.show();w.hand.show();w.hook.show();w.head.show();w.startButton.show();w.precisionBall.show();app.sfx.Driver.current.loadSound(w.music,P.loaded);app.ff.GameScene.catchCount=0;app.ff.State.fishPrice("fish1",b);app.ff.State.fishPrice("fish2",y);app.ff.State.fishPrice("fish3",k);w.standardDeviationGreen=app.ff.State.deviationGreen();w.standardDeviationYellow=app.ff.State.deviationYellow();w.standardDeviationRed=app.ff.State.deviationRed();w.hearts=app.ff.State.startingHearts();P.updateHearts()};P.cleanup=function(){w.musicChannel.stop();app.sfx.Driver.current.removeSound(w.music.id());P.base.cleanup();w=null;P=null};P.processCommand=function(e){if(P.base.processCommand(e)!=null){return}switch(e.code()){case"action":case"click":if(!w.playbackStarted){P.startPlayback()}else if(!w.handIsFishing){var a=true;var i=null;var t=e.time()-w.startTime;var n=w.findFishActivity(t,60,w.tolerance);switch(n){case"1":case"2":case"3":case"4":case"5":case"6":w.updateDeviation(w.findFishActivity.distance);i=P.findTaggedSprite(w.findFishActivity.beat);if(!i){break}a=false;w.head.frame(0);P.stop(i.id());i.frame(3);var o=Math.random()*15e3;P.bounceTo(i.id(),w.original.bucket.x+w.bucket.size.x/2-i.size.x/2,w.original.bucket.y-i.size.y/2,o|0+1e4,(o+1e4)/200+350,w.onFishOverTheBucket,.5,null);break;default:break}w.handIsFishing=true;if(a){w.updateDeviation(w.tolerance+60);w.head.frame(1)}P.move(w.hook.id(),w.original.hook.x,w.original.hook.y-1500,50,w.onHookIsUp);w.hand.frameskip(0,0);P.move(w.hand.id(),w.original.hand.x+200,w.original.hand.y-700,50,w.onHandIsUp)}break;case"altaction":w.onBucketClicked();break;default:break}};P.updateFrame=function(e){P.base.updateFrame(e);if(w.ended||w.aborted){return}if(w.playbackStarted&&w.startTime){var a=performance.now()-w.startTime;var i=a/w.music.duration();if(P.frame()%30==0){var t=i*10|0;if(t>0){w.progress[t-1].show()}if(t>9){w.progress[9].show()}else{if((P.frame()/30|0)%2==0){w.progress[t].show()}else{w.progress[t].hide()}}}var n=(a+w.fishTravelTime)/(w.millisecondsPerBeat/4);var o=n/2*Math.PI;var s=4*(1-Math.pow(2*a/w.music.duration()-1,2));if(s<0){s=0}else if(s>1){s=1}if(!w.handIsFishing){w.head.position.x=w.original.head.x-s*Math.sin(o-Math.PI/2)*30-25;w.head.position.y=w.original.head.y+s*Math.sin(o)*80+50;w.hand.position.x=w.original.hand.x;w.hand.position.y=w.original.hand.y-s*Math.abs(Math.cos(o/2+Math.PI/4))*200}n=Math.floor(n);if(w.lastBeats!=n){w.lastBeats=n;var r=w.getFishActivity(n);switch(r){case"1":if(w.latencyDeviation<w.standardDeviationGreen){w.addFish(w.fish3Pool,n)}else if(w.latencyDeviation<w.standardDeviationYellow){w.addFish(w.fish2Pool,n)}else{w.addFish(w.fish1Pool,n)}break;case"4":w.addFish(w.fish4Pool,n,w.millisecondsPerBeat/4);break;case"5":w.addFish(w.fish5Pool,n,w.millisecondsPerBeat/4);break;case"6":w.addFish(w.fish6Pool,n,w.millisecondsPerBeat/4);break;case"S":if(w.bucketPosition==0){w.siren.position.x=w.original.bucket.x-w.siren.size.x+1e3;w.siren.position.y=16e3;w.siren.animation(w.fishAnimationFrames,w.millisecondsPerBeat/4);w.siren.show();P.bounceTo(w.siren.id(),w.siren.position.x,w.original.bucket.y-1200,2e3,w.millisecondsPerBeat*3/4,function(){w.siren.frame(3);w.bucketPosition=1;w.bucket.frame(w.bucketPosition);P.delay(w.millisecondsPerBeat/4,function(){w.siren.animation(w.fishAnimationFrames,w.millisecondsPerBeat/4);P.bounceTo(w.siren.id(),w.siren.position.x,16e3,2e3,w.millisecondsPerBeat,function(){w.siren.frame(0);w.siren.hide()})})})}break;case"X":w.ended=true;P.complete();break;default:break}}}};w.updateDeviation=function(e){w.latencyDeviation=0;app.ff.GameScene.catchLatency[app.ff.GameScene.catchCount++%app.ff.GameScene.catchPoolSize]=e;if(app.ff.GameScene.catchCount<5){return}var a=app.ff.GameScene.catchCount<app.ff.GameScene.catchPoolSize?app.ff.GameScene.catchCount:app.ff.GameScene.catchPoolSize;w.latencyTotal=0;for(var i=0;i<a;i++){w.latencyTotal+=app.ff.GameScene.catchLatency[i]}w.latencyMean=1*w.latencyTotal/a;for(var i=0;i<a;i++){w.latencyDeviation+=(w.latencyMean-app.ff.GameScene.catchLatency[i])*(w.latencyMean-app.ff.GameScene.catchLatency[i])}w.latencyDeviation=w.latencyDeviation==0?0:Math.sqrt(w.latencyDeviation/a)/(w.millisecondsPerBeat/16);var t=0;if(w.latencyDeviation<.1){t=1}else if(w.latencyDeviation<w.standardDeviationGreen){t=1-.3333*(w.latencyDeviation-.1)/(w.standardDeviationGreen-.1)}else if(w.latencyDeviation<w.standardDeviationYellow){t=1-.3333-.3333*(w.latencyDeviation-w.standardDeviationGreen)/(w.standardDeviationYellow-w.standardDeviationGreen)}else if(w.latencyDeviation<w.standardDeviationRed){t=1-.6666-.3333*(w.latencyDeviation-w.standardDeviationYellow)/(w.standardDeviationRed-w.standardDeviationYellow)}else{t=0}w.precisionBall.position.x=1630+(5180-1630)*t;w.precisionBall.position.y=440+(460-440)*t};P.complete=function(){P.say("won");P.delay(2e3,function(){app.Scene.change(app.ff.ScoreScene)})};P.died=function(){w.aborted=true;app.ff.State.fish("fish1",0);app.ff.State.fish("fish2",0);app.ff.State.fish("fish3",0);app.ff.State.fish("fish4",0);app.ff.State.fish("fish5",0);app.ff.State.fish("fish6",0);P.updateHearts();w.musicChannel.stop();app.sfx.Driver.current.removeSound(w.music.id());w.playbackStarted=false;P.say("died");P.delay(2e3,function(){w.brokenHeart.show();w.restartButton.show();w.stopButton.show()})};P.abort=function(){w.aborted=true;if(app.Application.query["noabort"]!="true"){app.ff.State.fish("fish1",0);app.ff.State.fish("fish2",0);app.ff.State.fish("fish3",0);app.ff.State.fish("fish4",0);app.ff.State.fish("fish5",0);app.ff.State.fish("fish6",0)}P.updateHearts();w.musicChannel.stop();app.sfx.Driver.current.removeSound(w.music.id());w.playbackStarted=false;P.say("aborted");P.delay(2e3,function(){app.Scene.change(app.Application.query["noabort"]=="true"?app.ff.ScoreScene:app.ff.MapScene)})};P.restartPlayback=function(){P.bounce("restartButton",-300,200,function(){app.Scene.change(v)})};P.stopPlayback=function(){P.bounce("stopButton",-300,200,function(){app.Scene.change(app.Application.query["noabort"]=="true"?app.ff.ScoreScene:app.ff.MapScene)})};w.getFishActivity=function(e){var a=Math.floor(e/64);if(a>=w.patterns.length){return"X"}return w.patterns[a].charAt(e%64)};w.findFishActivity=function(e,a,i){w.findFishActivity.beat=null;w.findFishActivity.distance=null;w.findFishActivity.activity=null;var t=e-a-i;var n=e+i;var o=Math.ceil(t/(w.millisecondsPerBeat/4));var s=Math.floor(n/(w.millisecondsPerBeat/4));var r=null;var f=null;var p=null;var l=null;var c=null;for(var d=o;d<=s;d++){var h=Math.floor(d/64);if(h>=w.patterns.length){continue}switch(w.patterns[h].charAt(d%64)){case"1":case"2":case"3":case"4":case"5":case"6":r=d*w.millisecondsPerBeat/4;f=e-r;if(l===null||Math.abs(f)<Math.abs(l)){l=f;p=d;c=w.patterns[h].charAt(d%64)}break;default:break}}w.findFishActivity.beat=p;w.findFishActivity.distance=l;w.findFishActivity.activity=c;return c};w.findFishActivity.beat=null;w.findFishActivity.distance=null;w.findFishActivity.activity=null;w.fishUsed=function(e){for(var a=0;a<w.patterns.length;a++){for(var i=0;i<64;i++){if(w.patterns[a].charAt(i)==e){return true}}}return false};P.startPlayback=function(){w.abortButton.show();P.bounce("startButton",-300,200,function(){w.startButton.hide();P.say("starting")});if(w.music.loaded()){w.musicChannel.play("music",null,null,w.onMusicProgress)}};P.updateHearts=function(){for(var e=0;e<w.hearts;e++){w.heart[e].frame(0);w.heart[e].show()}for(;e<w.heart.length;e++){if(w.heart[e].visible&&w.heart[e]._frame==0){w.heart[e].frame(1);P.delay(500,w.heart[e].hide)}}};w.lastMusicProgress=-1;w.onMusicProgress=function(e){if(!w.playbackStarted){w.playbackStarted=true}if(e-app.sfx.Sound.audioDelay>w.lastMusicProgress){var a=performance.now()-(e-app.sfx.Sound.audioDelay);if(w.startTime===null||a>w.startTime){w.startTime=a;w.lastMusicProgress=e-app.sfx.Sound.audioDelay}}};w.onHandIsUp=function(){P.move(w.hand.id(),w.original.hand.x,w.original.hand.y,250,w.onHandIsBackDown)};w.onHandIsBackDown=function(){w.handIsFishing=false;w.hand.frameskip(3,0)};w.onHookIsUp=function(){w.hook.position.x=w.original.hook.x;w.hook.position.y=w.original.hook.y;P.bounce(w.hook.id(),1500,1e3,null,1,.5)};w.onBucketClicked=function(){w.bucketPosition=w.bucketPosition^1;w.bucket.frame(w.bucketPosition)};w.addFish=function(e,a,i){var t=e.get(12e3,14500-e.prototype().height/2);t.frameskip(0,0);t.position.x=12e3;t.position.y=t.position.y;t.points=50;t.animation(w.fishAnimationFrames,i?i:w.millisecondsPerBeat/2);t.tag(a);P.move(t.id(),770+w.hookOffset.x+w.fishermanOffset.x,14500-e.prototype().height/2,w.fishTravelTime|0,w.onFishReachedHook)};w.onFishReachedHook=function(e){P.move(e.id(),-e.size.x,14500-e.size.y/2,450,w.onFishLeft)};w.onFishLeft=function(e){if((e.id().substr(4,1)|0)<4&&!w.aborted){if(w.hearts==0){P.died()}else{w.hearts--;P.updateHearts()}}e.hide()};w.onFishOverTheBucket=function(e){if(w.bucketPosition==0){e.hide();if((e.id().substr(4,1)|0)>3&&!w.aborted){if(w.hearts==0){P.died()}else{w.hearts--;P.updateHearts()}}else{app.ff.State.addFish(e.id().substr(0,5))}P.bounce(w.bucket.id(),250,200)}else{P.move(e.id(),e.position.x+2e3,16e3,250,w.onFishBackInWater)}};w.onFishBackInWater=function(e){if((e.id().substr(4,1)|0)<4&&!w.aborted){if(w.hearts==0){P.died()}else{w.hearts--;P.updateHearts()}}e.hide()};w.onbaloon=function(){P.abortdelay(w.baloon.hide);w.baloon.hide()};P.say=function(e){P.abortdelay(w.baloon.hide);w.baloon.position.x=w.head.position.x+w.head.size.x;w.baloon.position.y=w.head.position.y+w.head.size.y/2-w.baloon.size.y;w.baloon.text(app.data.Strings.get(e));w.baloon.show();P.delay(2e3,w.baloon.hide)}};app.ff.GameScene.catchCount=0;app.ff.GameScene.catchPoolSize=16;app.ff.GameScene.catchLatency=new Int16Array(app.ff.GameScene.catchPoolSize);