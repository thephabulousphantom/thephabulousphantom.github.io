app.sfx.WebAudioDriver=function(){var e=Class.inherit(this,app.sfx.Driver);var n={};n.sounds={};n.playbacks={};n.audioContext=null;n.masterGain=null;n.muted=false;e.init=function(){if(typeof AudioContext!=="undefined"){n.audioContext=new AudioContext}else if(typeof webkitAudioContext!=="undefined"){n.audioContext=new webkitAudioContext}if(n.audioContext){n.masterGain=n.audioContext.createGain();n.masterGain.connect(n.audioContext.destination)}};e.cleanup=function(){delete n.audioContext};e.mute=function(e){if(e===undefined){return n.muted}n.masterGain.gain.value=e?0:1;n.muted=e};e.loadSound=function(e,o){var r=app.sfx.Driver.forceAudioMediaType;if(!r){var t=new Audio;if(!!(t.canPlayType&&t.canPlayType("audio/mpeg;").replace(/no/,""))){r=".mp3"}else if(!!(t.canPlayType&&t.canPlayType('audio/ogg; codecs="vorbis"').replace(/no/,""))){r=".ogg"}else{return false}}var a={sound:e,url:e.url()+r,buffer:null,callback:o};n.sounds[e.id()]=a;var s=new XMLHttpRequest;s.open("GET",e.url()+r,true);s.responseType="arraybuffer";s.onload=function(){n.decodeSound(a,s.response)};s.send();return true};n.decodeSound=function(e,o){n.audioContext.decodeAudioData(o,function(n){e.sound.loaded(true);e.buffer=n;if(e.callback){e.callback();e.callback=null}})};e.removeSound=function(e){if(!n.sounds[e]){return}delete n.sounds[e].buffer;delete n.sounds[e]};e.play=function(e,o,r,t){if(!n.sounds[e]){return null}var a={playbackId:app.sfx.WebAudioDriver.nextPlaybackId++,url:n.sounds[e].url,source:n.audioContext.createBufferSource(),onstarted:o,onfinished:r,onprogress:t,startTime:0,finishTimeoutId:0,progressIntervalId:0};n.playbacks[a.playbackId]=a;a.source.buffer=n.sounds[e].buffer;a.source.connect(n.masterGain);var s=a.onprogress?480:0;a.startTime=n.audioContext.currentTime+s/1e3;a.startTimePerformanceNow=window.performance.now()+s;if(a.source.start===undefined){a.source.noteGrainOn(a.startTime)}else{a.source.start(a.startTime)}a.source.volume=1;if(a.onstart){a.onstart();a.onstart=null}a.finishTimeoutId=setTimeout(function(){if(a.progressIntervalId){clearInterval(a.progressIntervalId);a.progressIntervalId=null}a.finishTimeoutId=null;if(a.onfinished){a.onfinished();a.onfinished=null}},n.sounds[e].sound.duration());if(a.onprogress){a.progressUpdateCount=0;a.offsetSum=0;a.offsetCount=0;a.offset=0;a.progressUpdateHandler=function(){var e=performance.now()-a.startTimePerformanceNow;if(a.progressUpdateCount<60){a.offsetSum+=1e3*(n.audioContext.currentTime-a.startTime)-e;a.offsetCount++;a.offset=a.offsetSum/a.offsetCount}else if(a.progressUpdateCount==60){clearInterval(a.progressIntervalId);a.progressIntervalId=setInterval(a.progressUpdateHandler,1e3)}++a.progressUpdateCount;a.onprogress(e+a.offset|0)};a.progressIntervalId=setInterval(a.progressUpdateHandler,100)}return a.playbackId};e.stop=function(e){if(!n.playbacks[e]){return}var o=n.playbacks[e];if(o.source.playbackState===o.source.PLAYING_STATE){o.source.stop()}if(o.finishTimeoutId){clearTimeout(o.finishTimeoutId)}if(o.progressIntervalId){clearInterval(o.progressIntervalId);o.progressIntervalId=null}if(o.onfinished){o.onfinished();o.onfinished=null}delete n.playbacks[e]}};app.sfx.WebAudioDriver.nextPlaybackId=0;