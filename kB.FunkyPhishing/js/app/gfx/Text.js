app.gfx.Text=function(e,t,i,a,n,r,g,l,s,o,c,h,f,m,p,x,u,y){var P=Class.inherit(this,app.gfx.Sprite,[e,t,1,l,s,o,c]);var T={};T.backgroundUrl=t;T.size=a;T.spacingPercent=n/100;T.font=r;T.color=g;T.marginTopLeft=new app.gfx.Size(p|0,u|0);T.marginBottomRight=new app.gfx.Size(x|0,y|0);T.lineHeight=app.gfx.Size.getPhysicalY(h);T.center=!!f;T.wrap=!!m;T.tempPosition={x:0,y:0};T.text=i;T.backgroundImage=null;P.position.x=l;P.position.y=s;P.size.x=o;P.size.y=c;P.init=function(e,t){if(!T.backgroundUrl){P.text(T.text?T.text:"");P.base.init(e,t)}else{var i=document.createElement("img");i.onload=function(){T.backgroundImage=i;P.text(T.text?T.text:"");P.base.init(e,t)};i.src=T.backgroundUrl}};P.wrap=function(e){if(e!==undefined){T.wrap=!!e}return T.wrap};T.measureText=function(e,t){var i=0;for(var a=0;a<t.length;a++){i+=e.measureText(t[a]).width*T.spacingPercent}return i};T.fillText=function(e,t,i,a){for(var n=0;n<t.length;n++){e.fillText(t[n],i,a);i+=e.measureText(t[n]).width*T.spacingPercent}};T.toDataURLFails=false;P.text=function(e){if(e!==undefined){T.text=""+e;var t=document.createElement("canvas");t.width=P.size.getPhysicalX();t.height=P.size.getPhysicalY();var i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);i.font=app.gfx.Size.getPhysicalX(T.size)+"px "+T.font;i.fillStyle=T.color;i.textBaseline="top";if(T.backgroundImage){i.drawImage(T.backgroundImage,0,0,T.backgroundImage.width,T.backgroundImage.height,0,0,t.width,t.height)}var a=T.marginTopLeft.getPhysicalY();if(T.lineHeight==null){T.lineHeight=i.measureText("m").width}if(T.wrap){var n=e.split(/\s+/);var r="";var g=P.size.getPhysicalX()-T.marginTopLeft.getPhysicalX()-T.marginBottomRight.getPhysicalX();var l=P.size.getPhysicalY()-T.marginBottomRight.getPhysicalY();var s=0;if(T.center){var o=T.lineHeight;for(var c=0;c<n.length;c++){var h=n[c];if(r!=""&&T.measureText(i,r+" "+h)>g){o+=T.lineHeight;r=h}else{r+=(r==""?"":" ")+h}}a=T.marginTopLeft.getPhysicalY()+(P.size.getPhysicalY()-T.marginTopLeft.getPhysicalY()-T.marginBottomRight.getPhysicalY()-o)/2}r="";for(var c=0;c<n.length;c++){var h=n[c];if(r!=""&&T.measureText(i,r+" "+h)>g){if(T.center){T.fillText(i,r,T.marginTopLeft.getPhysicalX()+(P.size.getPhysicalX()-T.marginTopLeft.getPhysicalX()-T.marginBottomRight.getPhysicalX()-T.measureText(i,r))/2,a|0)}else{T.fillText(i,r,T.marginTopLeft.getPhysicalX(),a|0)}a+=T.lineHeight;r=h}else{r+=(r==""?"":" ")+h}if(a>l){break}}if(a<=l){if(T.center){T.fillText(i,r,T.marginTopLeft.getPhysicalX()+(P.size.getPhysicalX()-T.marginTopLeft.getPhysicalX()-T.marginBottomRight.getPhysicalX()-T.measureText(i,r))/2,a|0)}else{T.fillText(i,r,T.marginTopLeft.getPhysicalX(),a|0)}}}else{var f=e.split("\n");for(var m=0;m<f.length;m++){var p=f[m];if(T.center){T.fillText(i,p,T.marginTopLeft.getPhysicalX()+(P.size.getPhysicalX()-T.marginTopLeft.getPhysicalX()-T.marginBottomRight.getPhysicalX()-T.measureText(i,p))/2,a|0)}else{T.fillText(i,p,T.marginTopLeft.getPhysicalX(),a|0)}a+=T.lineHeight;if(a>l){break}}}if(!T.toDataURLFails){try{P.imageUrl(t.toDataURL())}catch(x){T.toDataURLFails=true;P.text(e)}}}return T.text};P.cleanup=function(){P.base.cleanup();T=null;P=null}};