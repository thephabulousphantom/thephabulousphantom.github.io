app.gfx.CanvasDriver=function(){var e=Class.inherit(this,app.gfx.Driver);var a={};a.canvas=null;a.context2d=null;a.visualLookup={};a.visuals=[];a.dirtyRectangles=[{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0}];a.dirtyRectanglesCount=0;e.getcanvasId=function(){return"CanvasDriver_canvas"};e.init=function(){e.base.init();var t=document.createElement("canvas");t.id=e.getcanvasId();var i=new app.gfx.Size(12e3,16e3);t.width=i.getPhysicalX();t.height=i.getPhysicalY();var r=new app.gfx.Position(0,0);t.style.cssText="position:absolute;"+"left:"+r.getBrowserX()+"px;"+"top:"+r.getBrowserY()+"px;"+"width:"+i.getBrowserX()+"px;"+"height:"+i.getBrowserY()+"px;";document.body.innerHTML="";document.body.appendChild(t);document.body.style.cssText="overflow: hidden;";a.canvas=t;a.context2d=a.canvas.getContext("2d");var s=r.getPhysicalX();var n=r.getPhysicalY();r.setBrowser(0,0);a.context2d.translate(r.getPhysicalX()-s,r.getPhysicalY()-n);a.context2d.imageSmoothingEnabled=false};e.cleanup=function(){e.base.cleanup();while(a.visuals.length){e.removeVisual(a.visuals[a.visuals.length-1].data.id())}document.body.removeChild(a.canvas);delete a.canvas};a.addDirtyRectangle=function(e,t,i,r){for(var s=0;s<a.dirtyRectanglesCount;s++){var n=a.dirtyRectangles[s];if(n.x<e+i&&n.x+n.w>e&&n.y<t+r&&n.y+n.h>t){var l=n.x;n.x=(n.x<e?n.x:e)|0;n.w=Math.max(l+n.w,e+i)-n.x|0;l=n.y;n.y=(n.y<t?n.y:t)|0;n.h=Math.max(l+n.h,t+r)-n.y|0;return true}}if(a.dirtyRectanglesCount==a.dirtyRectangles){return false}var u=a.dirtyRectangles[a.dirtyRectanglesCount++];u.x=e;u.y=t;u.w=i;u.h=r;return true};a.updateDirtyRectangles=function(e,t){var i=e.data.position.getPhysicalX();var r=e.data.position.getPhysicalY();var s=e.data.size.getPhysicalX();var n=e.data.size.getPhysicalY();var l=e.previous.x!=i||e.previous.y!=r||e.previous.frame!=e.data._frame||e.previous.visible!==t||e.previous.width!=s||e.previous.height!=n;if(e.data.imageUrlChanged){e.data.imageUrlChanged=false;e.element.src=e.data.imageUrl();l=true}if(e.data.htmlChanged){e.data.htmlChanged=false;e.element.innerHTML=e.data.html();l=true}if(l){if(e.previous.visible){if(!a.addDirtyRectangle(e.previous.x,e.previous.y,e.previous.width,e.previous.height)){return false}}if(t){if(!a.addDirtyRectangle(i,r,s,n)){return false}}e.previous.x=i;e.previous.y=r;e.previous.width=s;e.previous.height=n;e.previous.frame=e.data._frame;e.previous.visible=t}return a.dirtyRectanglesCount<a.dirtyRectangles.length};e.updateFrame=function(e){if(!app.Scene.current){return}var t=app.Scene.current.frame()|0;a.dirtyRectanglesCount=0;for(var i=0;i<a.visuals.length;i++){var r=a.visuals[i];var s=r.data.visible&&r.loaded;if(!r.previous.visible){if(!s||r.parentVisualId&&!a.visualLookup[r.parentVisualId].data.visible){continue}}if(r.data.skipFrame(t)){continue}if(!a.updateDirtyRectangles(r,s)){break}}if(a.dirtyRectanglesCount==a.dirtyRectangles.length){for(var i=0;i<a.visuals.length;i++){var r=a.visuals[i];if(!(r.data.visible&&r.loaded)||r.parentVisualId&&!a.visualLookup[r.parentVisualId].data.visible){continue}a.context2d.drawImage(r.element,r.previous.frame*(r.element.width/r.data.frames()),0,r.element.width/r.data.frames(),r.element.height,r.previous.x,r.previous.y,r.previous.width,r.previous.height)}}else{for(var i=0;i<a.visuals.length;i++){var r=a.visuals[i];if(!(r.data.visible&&r.loaded)||r.parentVisualId&&!a.visualLookup[r.parentVisualId].data.visible){continue}for(var n=0;n<a.dirtyRectanglesCount;n++){var l=a.dirtyRectangles[n];if(r.previous.x<l.x+l.w&&r.previous.x+r.previous.width>l.x&&r.previous.y<l.y+l.h&&r.previous.y+r.previous.height>l.y){var u=r.previous.x>l.x?r.previous.x:l.x;var d=r.previous.y>l.y?r.previous.y:l.y;var o=Math.min(r.previous.x+r.previous.width,l.x+l.w);var v=Math.min(r.previous.y+r.previous.height,l.y+l.h);var h=1*(r.element.width/r.data.frames())/r.previous.width;var c=1*r.element.height/r.previous.height;a.context2d.drawImage(r.element,Math.round(r.previous.frame*r.element.width/r.data.frames()+(u-r.previous.x)*h),Math.round((d-r.previous.y)*c),Math.round((o-u)*h),Math.round((v-d)*c),u,d,o-u,v-d)}}}}};e.getVisualElementId=function(e){return"CanvasDriver_image_"+e.id()};e.addVisual=function(t,i,r){e.base.addVisual(t,i,r);if(t.html()!=null){a.addVisualHtml(t,i,r)}else{a.addVisualImage(t,i,r)}};a.addVisualImage=function(t,i,r){var s=document.createElement("img");var n={data:t,parentVisualId:i?i.id():null,element:s,loaded:false,previous:{visible:undefined,x:-999999,y:-999999,width:-999999,height:-999999,frame:-999999}};var l=new app.gfx.Size(12e3,16e3);var u=l.getPhysicalY()*1/1600;if(u>=1){s.onload=function(){if(r){r()}n.loaded=true}}else{s.onload=function(){var e=document.createElement("canvas");e.width=t.size.getPhysicalX()*t.frames();e.height=t.size.getPhysicalY();var a=e.getContext("2d");a.drawImage(s,0,0,s.width,s.height,0,0,e.width,e.height);var i=e.toDataURL();if(s.src==i){if(r){r()}n.loaded=true}else{s.onload=function(){if(r){r()}n.loaded=true};s.src=e.toDataURL()}}}a.visuals.push(n);a.visualLookup[t.id()]=n;t.imageUrlChanged=false;s.src=t.imageUrl();s.id=e.getVisualElementId(t)};a.resizeImage=function(e){};a.addVisualHtml=function(e,a,t){throw"CanvasDriver does not support addVisualHtml."};e.removeVisual=function(t){var i=a.visualLookup[t];if(i){for(var r=0;r<a.visuals.length;r++){if(a.visuals[r].data.id()==t){a.visuals.splice(r,1);break}}delete i.element;delete a.visualLookup[t]}e.base.removeVisual(t)}};