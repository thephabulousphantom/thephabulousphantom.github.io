app.gfx.CssTextDriver=function(){var e=Class.inherit(this,app.gfx.Driver);var i={};i.backgroundViewportElement=null;i.viewportElement=null;i.visualsLookup={};i.visuals=[];e.getViewportElementId=function(){return"CssTextDriver_viewport"};e.init=function(){e.base.init();document.body.innerHTML="";var t=document.createElement("div");t.id="bg_"+e.getViewportElementId();t.style.cssText="position:absolute;"+"overflow:hidden;"+"left:0px;"+"top:0px;"+"width:"+e.screenSize.browser.x+"px;"+"height:"+e.screenSize.browser.y+"px;";document.body.appendChild(t);i.backgroundViewportElement=t;t=document.createElement("div");t.id=e.getViewportElementId();t.style.cssText="position:absolute;"+"overflow:hidden;"+"left:0px;"+"top:0px;"+"width:"+e.screenSize.browser.x+"px;"+"height:"+e.screenSize.browser.y+"px;";document.body.appendChild(t);i.viewportElement=t};e.cleanup=function(){e.base.cleanup();for(var t=0;t<i.visuals.length;t++){e.removeVisual(i.visuals[t].data.id())}document.body.removeChild(i.viewportElement);document.body.removeChild(i.backgroundViewportElement);delete i.viewportElement;delete i.backgroundViewportElement};i.updateVisual=function(e,i,t,a,s,r,o){var n=false;if(i){var l=e.data.position.getBrowserX();var d=e.data.position.getBrowserY();var u=e.data.size.getBrowserX();var p=e.data.size.getBrowserY();if(e.previous.x!=l||e.previous.y!=d||e.previous.frame!=e.data._frame||e.previous.visible!==i||e.previous.width!=u||e.previous.height!=p){e.previous.frame=e.data._frame|0;e.previous.x=l;e.previous.y=d;e.previous.width=u;e.previous.height=p;n=true}}if(e.previous.visible!==i){e.previous.visible=!!i;n=true}if(n){var v=e.previous.x-e.previous.frame*e.previous.width+"px,"+e.previous.y+"px";e.element.style.cssText=!e.previous.visible?"display:none;":e.baseCssText+"transform:translate3d("+v+",0);-webkit-transform:translate3d("+v+",0);-ms-transform:translate("+v+");width:"+e.data.frames()*e.previous.width+"px;height:"+e.previous.height+"px;clip:rect("+(e.previous.y>s?0:s-e.previous.y)+"px,"+((e.previous.frame+1)*e.previous.width-(.5+Math.max(0,e.previous.x+e.previous.width-r)|0)|0)+"px,"+(e.previous.height-Math.max(0,e.previous.y+e.previous.height-o|0)|0)+"px,"+(e.previous.frame*e.previous.width+(e.previous.x>a?0:a-e.previous.x))+"px);"}if(e.data.imageUrlChanged){e.data.imageUrlChanged=false;e.element.src=e.data.imageUrl()}if(e.data.htmlChanged){e.data.htmlChanged=false;e.element.innerHTML=e.data.html()}};e.updateFrame=function(e){if(!app.Scene.current){return}var t=app.Scene.current.frame()|0;var a=app.Scene.current.position.getBrowserX();var s=app.Scene.current.position.getBrowserY();var r=a+app.Scene.current.size.getBrowserX();var o=s+app.Scene.current.size.getBrowserY();for(var n=0;n<i.visuals.length;n++){var l=i.visuals[n];visible=!!l.data.visible;if(visible&&l.parentVisualId){visible=!!i.visualsLookup[l.parentVisualId].data.visible}if(!visible&&!l.previous.visible){continue}if(l.data.skipFrame(t)){continue}i.updateVisual(l,visible,t,a,s,r,o)}};e.getVisualElementId=function(e){return"CssTextDriver_image_"+e.id()};e.addVisual=function(t,a,s){e.base.addVisual(t,a,s);if(t.html()!=null){i.addVisualHtml(t,a,s)}else{i.addVisualImage(t,a,s)}};i.addVisualImage=function(t,a,s){var r=document.createElement("img");var o=new app.gfx.Size(12e3,16e3);var n=o.getPhysicalY()*1/1600;if(n>=1){if(s){r.onload=s}}else{r.onload=function(){var e=t.frames();var i=r.style.cssText;r.style.cssText="";var a=document.createElement("canvas");a.width=r.width*n|0;a.width-=a.width%e;a.height=r.height*n|0;var o=a.getContext("2d");for(var l=0;l<e;l++){o.drawImage(r,l*r.width/e|0,0,r.width/e|0,r.height,l*a.width/e|0,0,a.width/e|0,a.height)}r.style.cssText=i;var d=a.toDataURL();if(r.src==d){if(s){s()}}else{if(s){r.onload=s}r.src=a.toDataURL()}}}t.imageUrlChanged=false;r.src=t.imageUrl();r.id=e.getVisualElementId(t);r.style.cssText="display:none;";if(t.addSprite){i.backgroundViewportElement.appendChild(r)}else{i.viewportElement.appendChild(r)}var l={data:t,parentVisualId:a?a.id():null,element:r,baseCssText:"position:absolute;"+"overflow:hidden;",previous:{visible:undefined,x:-999999,y:-999999,width:-999999,height:-999999,frame:-999999}};i.visuals.push(l);i.visualsLookup[t.id()]=l;r.style.cssText="display:none;"};i.addVisualHtml=function(t,a,s){var r=document.createElement("div");r.innerHTML=t.html();r.id=e.getVisualElementId(t);r.style.cssText="display:none;";i.viewportElement.appendChild(r);var o={data:t,parentVisualId:a?a.id():null,element:r,baseCssText:"position:absolute;"+"overflow:hidden;",previous:{visible:undefined,x:-999999,y:-999999,width:-999999,height:-999999,frame:-999999}};i.visuals.push(o);i.visualsLookup[t.id()]=o;r.style.cssText="display:none;";if(s){s(t)}};e.removeVisual=function(t){var a=i.visualsLookup[t];if(a){for(var s=0;s<i.visuals.length;s++){if(i.visuals[s].data.id()==a.data.id()){i.visuals.splice(s,1);break}}if(a.data.addSprite){i.backgroundViewportElement.removeChild(a.element)}else{i.viewportElement.removeChild(a.element)}delete a.element;delete i.visualsLookup[t]}e.base.removeVisual(t)}};