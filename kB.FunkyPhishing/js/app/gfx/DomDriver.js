app.gfx.DomDriver=function(){var e=Class.inherit(this,app.gfx.Driver);var t={};t.viewportElement=null;t.visuals={};e.getViewportElementId=function(){return"DomDriver_viewport"};e.init=function(){e.base.init();var a=document.createElement("div");a.id=e.getViewportElementId();a.style.position="absolute";a.style.overflow="hidden";a.style.left="0px";a.style.top="0px";a.style.width=e.screenSize.browser.x+"px";a.style.height=e.screenSize.browser.y+"px";document.body.innerHTML="";document.body.appendChild(a);t.viewportElement=a};e.cleanup=function(){e.base.cleanup();for(visualId in t.visuals){e.removeVisual(visualId)}document.body.removeChild(t.viewportElement);delete t.viewportElement};t.updateVisual=function(e,a,i,r,s,l){var n=t.visuals[e];var p=n.data.visible;if(p&&n.parentVisualId){p=t.visuals[n.parentVisualId].data.visible}if(p&&n.data.skipFrame(a)){return}var o=false;if(p){var u=n.data.position.getBrowserX();var m=n.data.position.getBrowserY();var d=n.data.size.getBrowserX();var v=n.data.size.getBrowserY();var x=n.data._frame|0;var h=false;if(n.previous.x!=u||n.previous.width!=d||n.previous.frame!=x){n.previous.x=u;n.element.style.left=u-x*d+"px";if(!h){n.element.style.clip="rect("+Math.max(0,r-m)+"px,"+((x+1)*d-Math.max(0,u+d-s))+"px, "+(v-Math.max(0,m+v-l))+"px, "+(x*d+Math.max(0,i-u))+"px)";h=true}}if(n.previous.y!=m){n.previous.y=m;n.element.style.top=m+"px";if(!h){n.element.style.clip="rect("+Math.max(0,r-m)+"px,"+((x+1)*d-Math.max(0,u+d-s))+"px, "+(v-Math.max(0,m+v-l))+"px, "+(x*d+Math.max(0,i-u))+"px)";h=true}}if(n.previous.frame!=x||n.previous.width!=d||n.previous.height!=v){n.previous.frame=x;if(!h){n.element.style.clip="rect("+Math.max(0,r-m)+"px,"+((x+1)*d-Math.max(0,u+d-s))+"px, "+(v-Math.max(0,m+v-l))+"px, "+(x*d+Math.max(0,i-u))+"px)";h=true}}if(n.previous.width!=d){n.previous.width=d;n.element.style.width=n.data.frames()*d+"px";if(!h){n.element.style.clip="rect("+Math.max(0,r-m)+"px,"+((x+1)*d-Math.max(0,u+d-s))+"px, "+(v-Math.max(0,m+v-l))+"px, "+(x*d+Math.max(0,i-u))+"px)";h=true}}if(n.previous.height!=v){n.previous.height=v;n.element.style.height=v+"px";if(!h){n.element.style.clip="rect("+Math.max(0,r-m)+"px,"+((x+1)*d-Math.max(0,u+d-s))+"px, "+(v-Math.max(0,m+v-l))+"px, "+(x*d+Math.max(0,i-u))+"px)";h=true}}}if(n.previous.visible!==p){n.previous.visible=p;n.element.style.display=p?"":"none"}if(n.data.imageUrlChanged){n.data.imageUrlChanged=false;n.element.src=n.data.imageUrl()}};e.updateFrame=function(e){if(!app.Scene.current){return}var a=app.Scene.current.frame()|0;var i=app.Scene.current.position.getBrowserX();var r=app.Scene.current.position.getBrowserY();var s=i+app.Scene.current.size.getBrowserX();var l=r+app.Scene.current.size.getBrowserY();for(var n in t.visuals){t.updateVisual(n,a,i,r,s,l)}};e.getVisualElementId=function(e){return"DomDriver_image_"+e.id()};e.addVisual=function(a,i,r){e.base.addVisual(a,i,r);var s=document.createElement("img");if(r){s.onload=r}a.imageUrlChanged=false;s.src=a.imageUrl();s.id=e.getVisualElementId(a);s.style.position="absolute";s.style.overflow="hidden";s.style.width="0px";s.style.height="0px";t.viewportElement.appendChild(s);t.visuals[a.id()]={data:a,parentVisualId:i?i.id():null,element:s,previous:{visible:undefined,x:-999999,y:-999999,width:-999999,height:-999999,frame:-999999}}};e.removeVisual=function(a){var i=t.visuals[a];if(i){t.viewportElement.removeChild(i.element);delete i.element;delete t.visuals[a]}e.base.removeVisual(a)}};